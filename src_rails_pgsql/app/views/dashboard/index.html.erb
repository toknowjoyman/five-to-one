<h2> 521 </h2>
<p>
  The time is now: <%= Time.now %>
</p>


<!-- NEW TO DO -->
<%= form_with scope: :to_do_item, url: to_do_items_path, local: true do |form| %>
<p>
  <%= form.hidden_field :parent, value: "NaN" %>
  <%= form.hidden_field :priority, value: "Nil" %>
  <%= form.text_field :title, placeholder: "New task" %>
  <%= @todos
  form.submit :"+" %>
</p>
<% end %>

<!-- 5 GOALS -->
<p><em>Drag to reorder your top 5 tasks</em></p>
<div id="mobile-sortable-tasks" style="margin: 20px 0;">
  <% @to_do_items.where(parent: "0").where("priority <= 5").order(:priority).each do |article| %>
    <div class="task-item" data-id="<%= article.id %>" style="
      padding: 15px;
      margin: 10px 0;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: move;
      touch-action: none;
      display: flex;
      align-items: center;
      gap: 10px;
    ">
      <span class="drag-icon" style="font-size: 20px; color: #666;">â˜°</span>
      <div style="flex: 1;">
        <%= link_to article.title, to_do_item_path(article), style: "text-decoration: none; color: #333; font-size: 16px;" %>
      </div>
      <span style="color: #999; font-size: 14px;">Priority: <%= article.priority %></span>
    </div>
  <% end %>
</div>

<!-- NON-TASKS -->
<p>
<strong> List: </strong>
<%= link_to "nontasks", to_do_items_path %>
</p>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var taskList = document.getElementById('mobile-sortable-tasks');
    if (taskList) {
      var sortable = Sortable.create(taskList, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        forceFallback: true, // Better mobile support
        fallbackTolerance: 3, // Sensitivity for touch devices
        onEnd: function(evt) {
          var taskIds = [];
          var items = taskList.querySelectorAll('.task-item[data-id]');
          items.forEach(function(item) {
            taskIds.push(item.getAttribute('data-id'));
          });

          fetch('/to_do_items/update_priorities', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
            },
            body: JSON.stringify({ tasks: taskIds })
          })
          .then(response => {
            if (response.ok) {
              console.log('Priorities updated successfully');
              // Reload to show updated priorities
              location.reload();
            }
          })
          .catch(error => console.error('Error updating priorities:', error));
        }
      });
    }
  });
</script>

<style>
  .sortable-ghost {
    opacity: 0.4;
    background: #e0e0e0;
  }

  .sortable-drag {
    opacity: 0.8;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  /* Mobile-specific styles */
  @media (max-width: 768px) {
    .task-item {
      font-size: 14px !important;
      padding: 12px !important;
    }

    .drag-icon {
      font-size: 18px !important;
      min-width: 30px;
      text-align: center;
    }
  }

  /* Prevent text selection during drag */
  .task-item {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
</style>
